import { kObject } from './internal.types.mjs';
import { TypstDocumentContext, composeDoc, provideDoc, } from './contrib/dom/typst-doc.mjs';
import { TypstCancellationToken } from './contrib/dom/typst-cancel.mjs';
const animationFrame = () => new Promise(resolve => requestAnimationFrame(resolve));
class DomPage {
    dispose() { }
}
var TrackMode;
(function (TrackMode) {
    TrackMode[TrackMode["Doc"] = 0] = "Doc";
    TrackMode[TrackMode["Pages"] = 1] = "Pages";
})(TrackMode || (TrackMode = {}));
var RepaintStage;
(function (RepaintStage) {
    RepaintStage[RepaintStage["Layout"] = 0] = "Layout";
    RepaintStage[RepaintStage["Svg"] = 1] = "Svg";
    RepaintStage[RepaintStage["Semantics"] = 2] = "Semantics";
    RepaintStage[RepaintStage["PrepareCanvas"] = 3] = "PrepareCanvas";
    RepaintStage[RepaintStage["Canvas"] = 4] = "Canvas";
})(RepaintStage || (RepaintStage = {}));
export function provideDomDoc(Base) {
    return class DomDocument extends Base {
        /// The template element for creating DOM by string.
        tmpl = document.createElement('template');
        /// The stub element for replacing an invisible element.
        stub = this.createElement('<stub></stub>');
        /// Typescript side of lib.
        plugin;
        /// Rust side of kernel.
        docKernel;
        /// The element to track.
        resourceHeader = undefined;
        /// Expected exact state of the current DOM.
        /// Initially it is empty meaning no any page is rendered.
        pages = [];
        /// The virtual scale of the document.
        domScale = 1;
        /// Track mode.
        track_mode = TrackMode.Doc;
        /// Current executing task.
        current_task = undefined;
        /// The currently maintained viewport.
        viewport;
        constructor(...args) {
            super(...args);
            this.registerMode('dom');
            this.disposeList.push(() => {
                this.dispose();
            });
            this.plugin = this.opts.renderer;
            if (this.opts.domScale !== undefined) {
                if (this.opts.domScale <= 0) {
                    throw new Error('domScale must be positive');
                }
                this.domScale = this.opts.domScale;
            }
        }
        dispose() {
            for (const page of this.pages) {
                page.dispose();
            }
            if (this.docKernel) {
                this.docKernel.free();
            }
        }
        createElement(tmpl) {
            this.tmpl.innerHTML = tmpl;
            return this.tmpl.content.firstElementChild;
        }
        async mountDom(pixelPerPt) {
            // console.log('mountDom', pixelPerPt);
            if (this.docKernel) {
                throw new Error('already mounted');
            }
            // create typst-svg-resources by string
            this.hookedElem.innerHTML = `<svg class="typst-svg-resources" viewBox="0 0 0 0" width="0" height="0" style="opacity: 0; position: absolute;"></svg>`;
            this.resourceHeader = this.hookedElem.querySelector('.typst-svg-resources');
            this.docKernel = await this.plugin.renderer.mount_dom(this.kModule[kObject], this.hookedElem);
            this.docKernel.bind_functions({
                populateGlyphs: (data) => {
                    let svg = this.createElement(data);
                    // console.log('populateGlyphs', svg);
                    let content = svg.firstElementChild;
                    this.resourceHeader.append(content);
                },
            });
        }
        async cancelAnyway$dom() {
            // console.log('cancelAnyway$dom');
            if (this.current_task) {
                const task = this.current_task;
                this.current_task = undefined;
                await task.cancel();
            }
        }
        retrieveDOMPages() {
            return Array.from(this.hookedElem.querySelectorAll('.typst-dom-page'));
        }
        // doesn't need to postRender
        postRender$dom() { }
        // doesn't need to rescale
        rescale$dom() { }
        getDomViewport(cachedWindow, cachedBoundingRect) {
            const left = cachedBoundingRect.left;
            const top = -cachedBoundingRect.top;
            const right = cachedBoundingRect.right;
            const bottom = cachedWindow.innerHeight - cachedBoundingRect.top;
            const rect = {
                x: 0,
                y: top / this.domScale,
                width: Math.max(right - left, 0) / this.domScale,
                height: Math.max(bottom - top, 0) / this.domScale,
            };
            if (rect.width <= 0 || rect.height <= 0) {
                rect.x = rect.y = rect.width = rect.height = 0;
            }
            // console.log('ccc', basePos, appPos, rect);
            return rect;
        }
        // fast mode
        async rerender$dom() {
            const domState = this.retrieveDOMState();
            // const l = domState.boundingRect.left;
            const { x, y, width, height } = this.getDomViewport(domState.window, domState.boundingRect);
            let dirty = await this.docKernel.relayout(x, y, width, height);
            if (!dirty) {
                return;
            }
            const cancel = new TypstCancellationToken();
            this.doRender$dom(cancel);
            this.current_task = cancel;
        }
        async doRender$dom(ctx) {
            const condOrExit = (needFrame, cb) => {
                if (needFrame && !ctx.isCancelRequested() && cb) {
                    return cb();
                }
            };
            const pages = this.retrieveDOMPages().map(page => {
                const { innerWidth, innerHeight } = window;
                const browserBBox = page.getBoundingClientRect();
                // any part of the page is in the window
                return {
                    inWindow: !(browserBBox.left > innerWidth ||
                        browserBBox.right < 0 ||
                        browserBBox.top > innerHeight ||
                        browserBBox.bottom < 0),
                    page,
                };
            });
            const renderPage = async (i) => {
                await animationFrame();
                if (ctx.isCancelRequested()) {
                    // console.log('cancel stage', RepaintStage.Layout, i);
                    return undefined;
                }
                const page = pages[i].page;
                const browserBBox = page.getBoundingClientRect();
                const v = this.getDomViewport(window, browserBBox);
                const needCalc = (stage) => this.docKernel.need_repaint(i, v.x, v.y, v.width, v.height, stage);
                const repaint = (stage) => this.docKernel.repaint(i, v.x, v.y, v.width, v.height, stage);
                const calc = (stage) => {
                    if (ctx.isCancelRequested()) {
                        return undefined;
                    }
                    return condOrExit(needCalc(stage), () => repaint(stage));
                };
                await calc(RepaintStage.Layout);
                const wScale = (browserBBox.width
                    ? Number.parseFloat(page.getAttribute('data-width')) / browserBBox.width
                    : 1) * this.domScale;
                const hScale = (browserBBox.height
                    ? Number.parseFloat(page.getAttribute('data-height')) / browserBBox.height
                    : 1) * this.domScale;
                v.x *= wScale;
                v.y *= hScale;
                v.y -= 100;
                v.width *= wScale;
                v.height *= hScale;
                v.height += 200;
                await calc(RepaintStage.Svg);
                await calc(RepaintStage.Semantics);
                if (ctx.isCancelRequested()) {
                    // console.log('cancel stage', RepaintStage.Semantics, i);
                    return undefined;
                }
                if (needCalc(RepaintStage.PrepareCanvas)) {
                    const calcCanvasAfterPreparing = async () => {
                        await repaint(RepaintStage.PrepareCanvas);
                        if (ctx.isCancelRequested()) {
                            return undefined;
                        }
                        return calc(RepaintStage.Canvas);
                    };
                    calcCanvasAfterPreparing();
                }
                else {
                    await calc(RepaintStage.Canvas);
                }
            };
            const renderPages = async (inWindow) => {
                for (let idx = 0; idx < pages.length; ++idx) {
                    if (ctx.isCancelRequested()) {
                        // console.log('cancel page', RepaintStage.Layout, idx);
                        return;
                    }
                    if (pages[idx].inWindow === inWindow) {
                        await renderPage(idx);
                    }
                }
            };
            this.cancelAnyway$dom();
            await renderPages(true);
            await renderPages(false);
            if (ctx.isCancelRequested()) {
                return;
            }
            // console.log('finished', RepaintStage.Layout);
        }
    };
}
export class TypstDomDocument extends provideDoc(composeDoc(TypstDocumentContext, provideDomDoc)) {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kb20ubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBUSxPQUFPLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVyRCxPQUFPLEVBRUwsb0JBQW9CLEVBQ3BCLFVBQVUsRUFDVixVQUFVLEdBQ1gsTUFBTSw2QkFBNkIsQ0FBQztBQUNyQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUV4RSxNQUFNLGNBQWMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFFcEYsTUFBTSxPQUFPO0lBQ1gsT0FBTyxLQUFLLENBQUM7Q0FDZDtBQUVELElBQVcsU0FHVjtBQUhELFdBQVcsU0FBUztJQUNsQix1Q0FBRyxDQUFBO0lBQ0gsMkNBQUssQ0FBQTtBQUNQLENBQUMsRUFIVSxTQUFTLEtBQVQsU0FBUyxRQUduQjtBQUVELElBQVcsWUFNVjtBQU5ELFdBQVcsWUFBWTtJQUNyQixtREFBVSxDQUFBO0lBQ1YsNkNBQU8sQ0FBQTtJQUNQLHlEQUFhLENBQUE7SUFDYixpRUFBaUIsQ0FBQTtJQUNqQixtREFBVSxDQUFBO0FBQ1osQ0FBQyxFQU5VLFlBQVksS0FBWixZQUFZLFFBTXRCO0FBZUQsTUFBTSxVQUFVLGFBQWEsQ0FDM0IsSUFBVztJQUVYLE9BQU8sTUFBTSxXQUFZLFNBQVEsSUFBSTtRQUNuQyxvREFBb0Q7UUFDcEQsSUFBSSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDMUMsd0RBQXdEO1FBQ3hELElBQUksR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzNDLDJCQUEyQjtRQUMzQixNQUFNLENBQXNCO1FBQzVCLHdCQUF3QjtRQUN4QixTQUFTLENBQW1CO1FBQzVC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RCxPQUFPO29CQUNULENBQUM7b0JBQ0QsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO3dCQUNyQyxNQUFNLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDeEIsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQyxDQUFDO1lBRUYsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFFeEIsTUFBTSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEIsTUFBTSxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDekIsSUFBSSxHQUFHLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDO2dCQUM1QixPQUFPO1lBQ1QsQ0FBQztZQUNELGdEQUFnRDtRQUNsRCxDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsVUFBVSxDQUM5QyxVQUFVLENBQ1Isb0JBQTBFLEVBQzFFLGFBQWEsQ0FDZCxDQUNGO0NBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEluY3JEb21Eb2NDbGllbnQgfSBmcm9tICdAbXlyaWFkZHJlYW1pbi90eXBzdC10cy1yZW5kZXJlcic7XHJcbmltcG9ydCB7IFJlY3QsIGtPYmplY3QgfSBmcm9tICcuL2ludGVybmFsLnR5cGVzLm1qcyc7XHJcbmltcG9ydCB7IFR5cHN0UmVuZGVyZXIsIFR5cHN0UmVuZGVyZXJEcml2ZXIgfSBmcm9tICcuL3JlbmRlcmVyLm1qcyc7XHJcbmltcG9ydCB7XHJcbiAgR0NvbnN0cnVjdG9yLFxyXG4gIFR5cHN0RG9jdW1lbnRDb250ZXh0LFxyXG4gIGNvbXBvc2VEb2MsXHJcbiAgcHJvdmlkZURvYyxcclxufSBmcm9tICcuL2NvbnRyaWIvZG9tL3R5cHN0LWRvYy5tanMnO1xyXG5pbXBvcnQgeyBUeXBzdENhbmNlbGxhdGlvblRva2VuIH0gZnJvbSAnLi9jb250cmliL2RvbS90eXBzdC1jYW5jZWwubWpzJztcclxuXHJcbmNvbnN0IGFuaW1hdGlvbkZyYW1lID0gKCkgPT4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVzb2x2ZSkpO1xyXG5cclxuY2xhc3MgRG9tUGFnZSB7XHJcbiAgZGlzcG9zZSgpIHsgfVxyXG59XHJcblxyXG5jb25zdCBlbnVtIFRyYWNrTW9kZSB7XHJcbiAgRG9jLFxyXG4gIFBhZ2VzLFxyXG59XHJcblxyXG5jb25zdCBlbnVtIFJlcGFpbnRTdGFnZSB7XHJcbiAgTGF5b3V0ID0gMCxcclxuICBTdmcgPSAxLFxyXG4gIFNlbWFudGljcyA9IDIsXHJcbiAgUHJlcGFyZUNhbnZhcyA9IDMsXHJcbiAgQ2FudmFzID0gNCxcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJVHlwc3REb21Eb2N1bWVudCB7XHJcbiAgbW91bnREb20ocGl4ZWxQZXJQdDogbnVtYmVyIHwgdW5kZWZpbmVkKTogUHJvbWlzZTx2b2lkPjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJbml0RG9tRG9jQXJncyB7XHJcbiAgcmVuZGVyZXI6IFR5cHN0UmVuZGVyZXI7XHJcbiAgZG9tU2NhbGU/OiBudW1iZXI7XHJcbn1cclxuXHJcbmludGVyZmFjZSBSZW5kZXJUYXNrIHtcclxuICBjYW5jZWwoKTogUHJvbWlzZTx2b2lkPjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVEb21Eb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3I8VHlwc3REb2N1bWVudENvbnRleHQ8SW5pdERvbURvY0FyZ3M+Pj4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbik6IFRCYXNlICYgR0NvbnN0cnVjdG9yPElUeXBzdERvbURvY3VtZW50PiB7XHJcbiAgcmV0dXJuIGNsYXNzIERvbURvY3VtZW50IGV4dGVuZHMgQmFzZSB7XHJcbiAgICAvLy8gVGhlIHRlbXBsYXRlIGVsZW1lbnQgZm9yIGNyZWF0aW5nIERPTSBieSBzdHJpbmcuXHJcbiAgICB0bXBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGVtcGxhdGUnKTtcclxuICAgIC8vLyBUaGUgc3R1YiBlbGVtZW50IGZvciByZXBsYWNpbmcgYW4gaW52aXNpYmxlIGVsZW1lbnQuXHJcbiAgICBzdHViID0gdGhpcy5jcmVhdGVFbGVtZW50KCc8c3R1Yj48L3N0dWI+Jyk7XHJcbiAgICAvLy8gVHlwZXNjcmlwdCBzaWRlIG9mIGxpYi5cclxuICAgIHBsdWdpbjogVHlwc3RSZW5kZXJlckRyaXZlcjtcclxuICAgIC8vLyBSdXN0IHNpZGUgb2Yga2VybmVsLlxyXG4gICAgZG9jS2VybmVsOiBJbmNyRG9tRG9jQ2xpZW50O1xyXG4gICAgLy8vIFRoZSBlbGVtZW50IHRvIHRyYWNrLlxyXG4gICAgcmVzb3VyY2VIZWFkZXI6IFNWR0VsZW1lbnQgPSB1bmRlZmluZWQhO1xyXG4gICAgLy8vIEV4cGVjdGVkIGV4YWN0IHN0YXRlIG9mIHRoZSBjdXJyZW50IERPTS5cclxuICAgIC8vLyBJbml0aWFsbHkgaXQgaXMgZW1wdHkgbWVhbmluZyBubyBhbnkgcGFnZSBpcyByZW5kZXJlZC5cclxuICAgIHBhZ2VzOiBEb21QYWdlW10gPSBbXTtcclxuICAgIC8vLyBUaGUgdmlydHVhbCBzY2FsZSBvZiB0aGUgZG9jdW1lbnQuXHJcbiAgICBkb21TY2FsZSA9IDE7XHJcbiAgICAvLy8gVHJhY2sgbW9kZS5cclxuICAgIHRyYWNrX21vZGU6IFRyYWNrTW9kZSA9IFRyYWNrTW9kZS5Eb2M7XHJcbiAgICAvLy8gQ3VycmVudCBleGVjdXRpbmcgdGFzay5cclxuICAgIGN1cnJlbnRfdGFzaz86IFJlbmRlclRhc2sgPSB1bmRlZmluZWQ7XHJcbiAgICAvLy8gVGhlIGN1cnJlbnRseSBtYWludGFpbmVkIHZpZXdwb3J0LlxyXG4gICAgdmlld3BvcnQ6IFJlY3Q7XHJcbiAgICBjb25zdHJ1Y3RvciguLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgICBzdXBlciguLi5hcmdzKTtcclxuICAgICAgdGhpcy5yZWdpc3Rlck1vZGUoJ2RvbScpO1xyXG4gICAgICB0aGlzLmRpc3Bvc2VMaXN0LnB1c2goKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZGlzcG9zZSgpO1xyXG4gICAgICB9KTtcclxuICAgICAgdGhpcy5wbHVnaW4gPSB0aGlzLm9wdHMucmVuZGVyZXIgYXMgYW55IGFzIFR5cHN0UmVuZGVyZXJEcml2ZXI7XHJcbiAgICAgIGlmICh0aGlzLm9wdHMuZG9tU2NhbGUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIGlmICh0aGlzLm9wdHMuZG9tU2NhbGUgPD0gMCkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdkb21TY2FsZSBtdXN0IGJlIHBvc2l0aXZlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZG9tU2NhbGUgPSB0aGlzLm9wdHMuZG9tU2NhbGU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBkaXNwb3NlKCkge1xyXG4gICAgICBmb3IgKGNvbnN0IHBhZ2Ugb2YgdGhpcy5wYWdlcykge1xyXG4gICAgICAgIHBhZ2UuZGlzcG9zZSgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAodGhpcy5kb2NLZXJuZWwpIHtcclxuICAgICAgICB0aGlzLmRvY0tlcm5lbC5mcmVlKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVFbGVtZW50KHRtcGw6IHN0cmluZykge1xyXG4gICAgICB0aGlzLnRtcGwuaW5uZXJIVE1MID0gdG1wbDtcclxuICAgICAgcmV0dXJuIHRoaXMudG1wbC5jb250ZW50LmZpcnN0RWxlbWVudENoaWxkO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIG1vdW50RG9tKHBpeGVsUGVyUHQ6IG51bWJlciB8IHVuZGVmaW5lZCkge1xyXG4gICAgICAvLyBjb25zb2xlLmxvZygnbW91bnREb20nLCBwaXhlbFBlclB0KTtcclxuXHJcbiAgICAgIGlmICh0aGlzLmRvY0tlcm5lbCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignYWxyZWFkeSBtb3VudGVkJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIGNyZWF0ZSB0eXBzdC1zdmctcmVzb3VyY2VzIGJ5IHN0cmluZ1xyXG4gICAgICB0aGlzLmhvb2tlZEVsZW0uaW5uZXJIVE1MID0gYDxzdmcgY2xhc3M9XCJ0eXBzdC1zdmctcmVzb3VyY2VzXCIgdmlld0JveD1cIjAgMCAwIDBcIiB3aWR0aD1cIjBcIiBoZWlnaHQ9XCIwXCIgc3R5bGU9XCJvcGFjaXR5OiAwOyBwb3NpdGlvbjogYWJzb2x1dGU7XCI+PC9zdmc+YDtcclxuICAgICAgdGhpcy5yZXNvdXJjZUhlYWRlciA9IHRoaXMuaG9va2VkRWxlbS5xdWVyeVNlbGVjdG9yKCcudHlwc3Qtc3ZnLXJlc291cmNlcycpITtcclxuXHJcbiAgICAgIHRoaXMuZG9jS2VybmVsID0gYXdhaXQgdGhpcy5wbHVnaW4ucmVuZGVyZXIubW91bnRfZG9tKHRoaXMua01vZHVsZVtrT2JqZWN0XSwgdGhpcy5ob29rZWRFbGVtKTtcclxuXHJcbiAgICAgIHRoaXMuZG9jS2VybmVsLmJpbmRfZnVuY3Rpb25zKHtcclxuICAgICAgICBwb3B1bGF0ZUdseXBoczogKGRhdGE6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgbGV0IHN2ZyA9IHRoaXMuY3JlYXRlRWxlbWVudChkYXRhKSE7XHJcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZygncG9wdWxhdGVHbHlwaHMnLCBzdmcpO1xyXG4gICAgICAgICAgbGV0IGNvbnRlbnQgPSBzdmcuZmlyc3RFbGVtZW50Q2hpbGQhO1xyXG4gICAgICAgICAgdGhpcy5yZXNvdXJjZUhlYWRlci5hcHBlbmQoY29udGVudCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgY2FuY2VsQW55d2F5JGRvbSgpIHtcclxuICAgICAgLy8gY29uc29sZS5sb2coJ2NhbmNlbEFueXdheSRkb20nKTtcclxuICAgICAgaWYgKHRoaXMuY3VycmVudF90YXNrKSB7XHJcbiAgICAgICAgY29uc3QgdGFzayA9IHRoaXMuY3VycmVudF90YXNrO1xyXG4gICAgICAgIHRoaXMuY3VycmVudF90YXNrID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIGF3YWl0IHRhc2suY2FuY2VsKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXRyaWV2ZURPTVBhZ2VzKCkge1xyXG4gICAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmhvb2tlZEVsZW0ucXVlcnlTZWxlY3RvckFsbCgnLnR5cHN0LWRvbS1wYWdlJykpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGRvZXNuJ3QgbmVlZCB0byBwb3N0UmVuZGVyXHJcbiAgICBwb3N0UmVuZGVyJGRvbSgpIHsgfVxyXG5cclxuICAgIC8vIGRvZXNuJ3QgbmVlZCB0byByZXNjYWxlXHJcbiAgICByZXNjYWxlJGRvbSgpIHsgfVxyXG5cclxuICAgIGdldERvbVZpZXdwb3J0KFxyXG4gICAgICBjYWNoZWRXaW5kb3c6IFBpY2s8V2luZG93LCAnaW5uZXJIZWlnaHQnIHwgJ2lubmVyV2lkdGgnPixcclxuICAgICAgY2FjaGVkQm91bmRpbmdSZWN0OiBQaWNrPERPTVJlY3QsICdsZWZ0JyB8ICd0b3AnIHwgJ3JpZ2h0Jz4sXHJcbiAgICApIHtcclxuICAgICAgY29uc3QgbGVmdCA9IGNhY2hlZEJvdW5kaW5nUmVjdC5sZWZ0O1xyXG4gICAgICBjb25zdCB0b3AgPSAtY2FjaGVkQm91bmRpbmdSZWN0LnRvcDtcclxuICAgICAgY29uc3QgcmlnaHQgPSBjYWNoZWRCb3VuZGluZ1JlY3QucmlnaHQ7XHJcbiAgICAgIGNvbnN0IGJvdHRvbSA9IGNhY2hlZFdpbmRvdy5pbm5lckhlaWdodCAtIGNhY2hlZEJvdW5kaW5nUmVjdC50b3A7XHJcbiAgICAgIGNvbnN0IHJlY3QgPSB7XHJcbiAgICAgICAgeDogMCxcclxuICAgICAgICB5OiB0b3AgLyB0aGlzLmRvbVNjYWxlLFxyXG4gICAgICAgIHdpZHRoOiBNYXRoLm1heChyaWdodCAtIGxlZnQsIDApIC8gdGhpcy5kb21TY2FsZSxcclxuICAgICAgICBoZWlnaHQ6IE1hdGgubWF4KGJvdHRvbSAtIHRvcCwgMCkgLyB0aGlzLmRvbVNjYWxlLFxyXG4gICAgICB9O1xyXG4gICAgICBpZiAocmVjdC53aWR0aCA8PSAwIHx8IHJlY3QuaGVpZ2h0IDw9IDApIHtcclxuICAgICAgICByZWN0LnggPSByZWN0LnkgPSByZWN0LndpZHRoID0gcmVjdC5oZWlnaHQgPSAwO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdjY2MnLCBiYXNlUG9zLCBhcHBQb3MsIHJlY3QpO1xyXG4gICAgICByZXR1cm4gcmVjdDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBmYXN0IG1vZGVcclxuICAgIGFzeW5jIHJlcmVuZGVyJGRvbSgpIHtcclxuICAgICAgY29uc3QgZG9tU3RhdGUgPSB0aGlzLnJldHJpZXZlRE9NU3RhdGUoKTtcclxuXHJcbiAgICAgIC8vIGNvbnN0IGwgPSBkb21TdGF0ZS5ib3VuZGluZ1JlY3QubGVmdDtcclxuICAgICAgY29uc3QgeyB4LCB5LCB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLmdldERvbVZpZXdwb3J0KGRvbVN0YXRlLndpbmRvdywgZG9tU3RhdGUuYm91bmRpbmdSZWN0KTtcclxuXHJcbiAgICAgIGxldCBkaXJ0eSA9IGF3YWl0IHRoaXMuZG9jS2VybmVsLnJlbGF5b3V0KHgsIHksIHdpZHRoLCBoZWlnaHQpO1xyXG4gICAgICBpZiAoIWRpcnR5KSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBjYW5jZWwgPSBuZXcgVHlwc3RDYW5jZWxsYXRpb25Ub2tlbigpO1xyXG4gICAgICB0aGlzLmRvUmVuZGVyJGRvbShjYW5jZWwpO1xyXG4gICAgICB0aGlzLmN1cnJlbnRfdGFzayA9IGNhbmNlbDtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBkb1JlbmRlciRkb20oY3R4OiBUeXBzdENhbmNlbGxhdGlvblRva2VuKSB7XHJcbiAgICAgIGNvbnN0IGNvbmRPckV4aXQgPSA8VCw+KG5lZWRGcmFtZTogYm9vbGVhbiwgY2I6ICgpID0+IFByb21pc2U8VD4pID0+IHtcclxuICAgICAgICBpZiAobmVlZEZyYW1lICYmICFjdHguaXNDYW5jZWxSZXF1ZXN0ZWQoKSAmJiBjYikge1xyXG4gICAgICAgICAgcmV0dXJuIGNiKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgICBjb25zdCBwYWdlcyA9IHRoaXMucmV0cmlldmVET01QYWdlcygpLm1hcChwYWdlID0+IHtcclxuICAgICAgICBjb25zdCB7IGlubmVyV2lkdGgsIGlubmVySGVpZ2h0IH0gPSB3aW5kb3c7XHJcbiAgICAgICAgY29uc3QgYnJvd3NlckJCb3ggPSBwYWdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIC8vIGFueSBwYXJ0IG9mIHRoZSBwYWdlIGlzIGluIHRoZSB3aW5kb3dcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgaW5XaW5kb3c6ICEoXHJcbiAgICAgICAgICAgIGJyb3dzZXJCQm94LmxlZnQgPiBpbm5lcldpZHRoIHx8XHJcbiAgICAgICAgICAgIGJyb3dzZXJCQm94LnJpZ2h0IDwgMCB8fFxyXG4gICAgICAgICAgICBicm93c2VyQkJveC50b3AgPiBpbm5lckhlaWdodCB8fFxyXG4gICAgICAgICAgICBicm93c2VyQkJveC5ib3R0b20gPCAwXHJcbiAgICAgICAgICApLFxyXG4gICAgICAgICAgcGFnZSxcclxuICAgICAgICB9O1xyXG4gICAgICB9KTtcclxuICAgICAgY29uc3QgcmVuZGVyUGFnZSA9IGFzeW5jIChpOiBudW1iZXIpID0+IHtcclxuICAgICAgICBhd2FpdCBhbmltYXRpb25GcmFtZSgpO1xyXG4gICAgICAgIGlmIChjdHguaXNDYW5jZWxSZXF1ZXN0ZWQoKSkge1xyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coJ2NhbmNlbCBzdGFnZScsIFJlcGFpbnRTdGFnZS5MYXlvdXQsIGkpO1xyXG4gICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFnZSA9IHBhZ2VzW2ldLnBhZ2U7XHJcbiAgICAgICAgY29uc3QgYnJvd3NlckJCb3ggPSBwYWdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGNvbnN0IHYgPSB0aGlzLmdldERvbVZpZXdwb3J0KHdpbmRvdywgYnJvd3NlckJCb3gpO1xyXG5cclxuICAgICAgICBjb25zdCBuZWVkQ2FsYyA9IChzdGFnZTogUmVwYWludFN0YWdlKSA9PlxyXG4gICAgICAgICAgdGhpcy5kb2NLZXJuZWwubmVlZF9yZXBhaW50KGksIHYueCwgdi55LCB2LndpZHRoLCB2LmhlaWdodCwgc3RhZ2UpO1xyXG4gICAgICAgIGNvbnN0IHJlcGFpbnQgPSAoc3RhZ2U6IFJlcGFpbnRTdGFnZSkgPT5cclxuICAgICAgICAgIHRoaXMuZG9jS2VybmVsLnJlcGFpbnQoaSwgdi54LCB2LnksIHYud2lkdGgsIHYuaGVpZ2h0LCBzdGFnZSk7XHJcbiAgICAgICAgY29uc3QgY2FsYyA9IChzdGFnZTogUmVwYWludFN0YWdlKSA9PiB7XHJcbiAgICAgICAgICBpZiAoY3R4LmlzQ2FuY2VsUmVxdWVzdGVkKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBjb25kT3JFeGl0KG5lZWRDYWxjKHN0YWdlKSwgKCkgPT4gcmVwYWludChzdGFnZSkpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGF3YWl0IGNhbGMoUmVwYWludFN0YWdlLkxheW91dCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHdTY2FsZSA9XHJcbiAgICAgICAgICAoYnJvd3NlckJCb3gud2lkdGhcclxuICAgICAgICAgICAgPyBOdW1iZXIucGFyc2VGbG9hdChwYWdlLmdldEF0dHJpYnV0ZSgnZGF0YS13aWR0aCcpISkgLyBicm93c2VyQkJveC53aWR0aFxyXG4gICAgICAgICAgICA6IDEpICogdGhpcy5kb21TY2FsZTtcclxuICAgICAgICBjb25zdCBoU2NhbGUgPVxyXG4gICAgICAgICAgKGJyb3dzZXJCQm94LmhlaWdodFxyXG4gICAgICAgICAgICA/IE51bWJlci5wYXJzZUZsb2F0KHBhZ2UuZ2V0QXR0cmlidXRlKCdkYXRhLWhlaWdodCcpISkgLyBicm93c2VyQkJveC5oZWlnaHRcclxuICAgICAgICAgICAgOiAxKSAqIHRoaXMuZG9tU2NhbGU7XHJcbiAgICAgICAgdi54ICo9IHdTY2FsZTtcclxuICAgICAgICB2LnkgKj0gaFNjYWxlO1xyXG4gICAgICAgIHYueSAtPSAxMDA7XHJcbiAgICAgICAgdi53aWR0aCAqPSB3U2NhbGU7XHJcbiAgICAgICAgdi5oZWlnaHQgKj0gaFNjYWxlO1xyXG4gICAgICAgIHYuaGVpZ2h0ICs9IDIwMDtcclxuXHJcbiAgICAgICAgYXdhaXQgY2FsYyhSZXBhaW50U3RhZ2UuU3ZnKTtcclxuICAgICAgICBhd2FpdCBjYWxjKFJlcGFpbnRTdGFnZS5TZW1hbnRpY3MpO1xyXG4gICAgICAgIGlmIChjdHguaXNDYW5jZWxSZXF1ZXN0ZWQoKSkge1xyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coJ2NhbmNlbCBzdGFnZScsIFJlcGFpbnRTdGFnZS5TZW1hbnRpY3MsIGkpO1xyXG4gICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG5lZWRDYWxjKFJlcGFpbnRTdGFnZS5QcmVwYXJlQ2FudmFzKSkge1xyXG4gICAgICAgICAgY29uc3QgY2FsY0NhbnZhc0FmdGVyUHJlcGFyaW5nID0gYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBhd2FpdCByZXBhaW50KFJlcGFpbnRTdGFnZS5QcmVwYXJlQ2FudmFzKTtcclxuICAgICAgICAgICAgaWYgKGN0eC5pc0NhbmNlbFJlcXVlc3RlZCgpKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gY2FsYyhSZXBhaW50U3RhZ2UuQ2FudmFzKTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBjYWxjQ2FudmFzQWZ0ZXJQcmVwYXJpbmcoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgYXdhaXQgY2FsYyhSZXBhaW50U3RhZ2UuQ2FudmFzKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IHJlbmRlclBhZ2VzID0gYXN5bmMgKGluV2luZG93OiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgZm9yIChsZXQgaWR4ID0gMDsgaWR4IDwgcGFnZXMubGVuZ3RoOyArK2lkeCkge1xyXG4gICAgICAgICAgaWYgKGN0eC5pc0NhbmNlbFJlcXVlc3RlZCgpKSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdjYW5jZWwgcGFnZScsIFJlcGFpbnRTdGFnZS5MYXlvdXQsIGlkeCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmIChwYWdlc1tpZHhdLmluV2luZG93ID09PSBpbldpbmRvdykge1xyXG4gICAgICAgICAgICBhd2FpdCByZW5kZXJQYWdlKGlkeCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgdGhpcy5jYW5jZWxBbnl3YXkkZG9tKCk7XHJcblxyXG4gICAgICBhd2FpdCByZW5kZXJQYWdlcyh0cnVlKTtcclxuICAgICAgYXdhaXQgcmVuZGVyUGFnZXMoZmFsc2UpO1xyXG4gICAgICBpZiAoY3R4LmlzQ2FuY2VsUmVxdWVzdGVkKCkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgLy8gY29uc29sZS5sb2coJ2ZpbmlzaGVkJywgUmVwYWludFN0YWdlLkxheW91dCk7XHJcbiAgICB9XHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFR5cHN0RG9tRG9jdW1lbnQgZXh0ZW5kcyBwcm92aWRlRG9jKFxyXG4gIGNvbXBvc2VEb2MoXHJcbiAgICBUeXBzdERvY3VtZW50Q29udGV4dCBhcyBHQ29uc3RydWN0b3I8VHlwc3REb2N1bWVudENvbnRleHQ8SW5pdERvbURvY0FyZ3M+PixcclxuICAgIHByb3ZpZGVEb21Eb2MsXHJcbiAgKSxcclxuKSB7IH1cclxuIl19